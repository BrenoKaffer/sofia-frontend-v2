import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth-server';
import { backendIntegration } from '@/lib/backend-integration';

// Interface para filtros de hist√≥rico de roleta
interface RouletteHistoryFilters {
  table_id?: string;
  limit?: number;
  offset?: number;
  page?: number;
  date_from?: string;
  date_to?: string;
}

// Interface para resposta da API
interface ApiResponse {
  data: any[];
  pagination: {
    current_page: number;
    total_pages: number;
    total_items: number;
    returned_count: number;
    items_per_page: number;
  };
  success: boolean;
  message?: string;
}

export async function GET(request: NextRequest) {
  // Extrair par√¢metros da query
  const { searchParams } = new URL(request.url);
  const filters: RouletteHistoryFilters = {
    table_id: searchParams.get('table_id') || undefined,
    limit: searchParams.get('limit') ? parseInt(searchParams.get('limit')!) : 50,
    page: searchParams.get('page') ? parseInt(searchParams.get('page')!) : 1,
    date_from: searchParams.get('date_from') || undefined,
    date_to: searchParams.get('date_to') || undefined
  };
  
  try {
    console.log('üöÄ Iniciando API de hist√≥rico de roletas...');
    
    // Verificar autentica√ß√£o
    const { userId } = await auth();
    if (!userId) {
      return NextResponse.json(
        { error: 'N√£o autorizado' },
        { status: 401 }
      );
    }

    // Calcular offset baseado na p√°gina
    filters.offset = ((filters.page || 1) - 1) * (filters.limit || 50);

    // Buscar hist√≥rico usando o servi√ßo de integra√ß√£o
    console.log('üîç Buscando hist√≥rico de roletas...');
    
    const result = await backendIntegration.getRouletteHistory(
      filters.table_id,
      filters.limit || 50,
      filters.offset || 0,
      filters.date_from,
      filters.date_to
    );

    if (!result.success) {
      console.warn('‚ö†Ô∏è Erro ao buscar hist√≥rico:', result.message);
      
      const errorResponse: ApiResponse = {
        data: [],
        pagination: {
          current_page: filters.page || 1,
          total_pages: 1,
          total_items: 0,
          returned_count: 0,
          items_per_page: filters.limit || 50
        },
        success: false,
        message: result.message || 'Erro ao buscar hist√≥rico'
      };
      
      return NextResponse.json(errorResponse);
    }

    console.log('‚úÖ Hist√≥rico de roletas obtido:', Array.isArray(result.data) ? result.data.length : 0, 'registros');

    // Estruturar resposta com pagina√ß√£o
    const responseData: ApiResponse = {
      data: Array.isArray(result.data) ? result.data : [],
      pagination: (result as any).pagination || {
        current_page: filters.page || 1,
        total_pages: 1,
        total_items: Array.isArray(result.data) ? result.data.length : 0,
        returned_count: Array.isArray(result.data) ? result.data.length : 0,
        items_per_page: filters.limit || 50
      },
      success: true,
      message: result.message || 'Hist√≥rico obtido com sucesso'
    };
    
    return NextResponse.json(responseData);

  } catch (error) {
    console.error('Erro na API de hist√≥rico da roleta:', error);
    
    const errorResponse: ApiResponse = {
      data: [],
      pagination: {
        current_page: filters?.page || 1,
        total_pages: 1,
        total_items: 0,
        returned_count: 0,
        items_per_page: filters?.limit || 50
      },
      success: false,
      message: error instanceof Error ? error.message : 'Erro interno do servidor'
    };
    
    return NextResponse.json(errorResponse, { status: 500 });
  }
}

/**
 * Endpoint OPTIONS para informa√ß√µes da API
 */
export async function OPTIONS() {
  return NextResponse.json({
    methods: ['GET'],
    description: 'Endpoint para buscar hist√≥rico de giros da roleta com filtros e pagina√ß√£o',
    parameters: {
      table_id: 'string - ID da mesa para filtrar',
      limit: 'number - Itens por p√°gina (padr√£o: 50, m√°ximo: 100)',
      page: 'number - P√°gina atual (padr√£o: 1)',
      offset: 'number - Calculado automaticamente baseado na p√°gina',
      date_from: 'string - Data inicial (YYYY-MM-DD)',
      date_to: 'string - Data final (YYYY-MM-DD)'
    },
    response_format: {
      data: 'array - Lista de giros da roleta',
      pagination: 'object - Informa√ß√µes de pagina√ß√£o',
      success: 'boolean - Status da opera√ß√£o',
      message: 'string - Mensagem opcional'
    },
    pagination_info: {
      current_page: 'P√°gina atual',
      total_pages: 'Total de p√°ginas dispon√≠veis',
      total_items: 'Total de itens encontrados',
      returned_count: 'Quantidade de itens retornados nesta p√°gina',
      items_per_page: 'Itens por p√°gina'
    }
  });
}
